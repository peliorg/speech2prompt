name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      tag: ${{ steps.set_version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must be in semantic format (e.g., 1.2.3)"
            exit 1
          fi

      - name: Set version output
        id: set_version
        run: |
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          echo "tag=v${{ inputs.version }}" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update desktop version (Cargo.toml)
        run: |
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' desktop/Cargo.toml
          echo "Updated desktop/Cargo.toml to version ${{ inputs.version }}"
          grep '^version =' desktop/Cargo.toml

      - name: Update Android version (pubspec.yaml)
        run: |
          # Calculate build number from GitHub run number
          BUILD_NUMBER=${{ github.run_number }}
          sed -i "s/^version: .*/version: ${{ inputs.version }}+${BUILD_NUMBER}/" android/pubspec.yaml
          echo "Updated android/pubspec.yaml to version ${{ inputs.version }}+${BUILD_NUMBER}"
          grep '^version:' android/pubspec.yaml

      - name: Commit version changes
        run: |
          git add desktop/Cargo.toml android/pubspec.yaml
          git commit -m "chore: bump version to ${{ inputs.version }}"
          git push origin main

      - name: Create and push tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

  linux:
    name: Build Linux Packages
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libadwaita-1-dev \
            libdbus-1-dev \
            libsqlite3-dev \
            libbluetooth-dev \
            libxdo-dev \
            pkg-config \
            build-essential \
            imagemagick \
            rpm \
            fakeroot \
            dpkg-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            desktop/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('desktop/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build release binary
        working-directory: desktop
        run: |
          cargo build --release --verbose
          strip target/release/speech2code-desktop

      - name: Build .deb package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PACKAGE_NAME="speech2code_${VERSION}_amd64"
          PACKAGE_DIR="${PACKAGE_NAME}"
          
          # Create package structure
          mkdir -p "${PACKAGE_DIR}/DEBIAN"
          mkdir -p "${PACKAGE_DIR}/usr/bin"
          mkdir -p "${PACKAGE_DIR}/usr/share/applications"
          mkdir -p "${PACKAGE_DIR}/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "${PACKAGE_DIR}/usr/lib/systemd/user"
          
          # Copy binary
          cp desktop/target/release/speech2code-desktop "${PACKAGE_DIR}/usr/bin/"
          chmod 755 "${PACKAGE_DIR}/usr/bin/speech2code-desktop"
          
          # Copy desktop file
          cp desktop/resources/speech2code.desktop "${PACKAGE_DIR}/usr/share/applications/"
          
          # Copy icon (if exists)
          if [ -f desktop/resources/icons/speech2code.png ]; then
            cp desktop/resources/icons/speech2code.png "${PACKAGE_DIR}/usr/share/icons/hicolor/256x256/apps/"
          fi
          
          # Copy systemd service
          cp desktop/resources/speech2code.service "${PACKAGE_DIR}/usr/lib/systemd/user/"
          
          # Copy control file
          cp desktop/packaging/deb/DEBIAN/control "${PACKAGE_DIR}/DEBIAN/"
          sed -i "s/VERSION/${VERSION}/" "${PACKAGE_DIR}/DEBIAN/control"
          
          # Copy maintainer scripts
          cp desktop/packaging/deb/DEBIAN/postinst "${PACKAGE_DIR}/DEBIAN/"
          cp desktop/packaging/deb/DEBIAN/prerm "${PACKAGE_DIR}/DEBIAN/"
          chmod 755 "${PACKAGE_DIR}/DEBIAN/postinst"
          chmod 755 "${PACKAGE_DIR}/DEBIAN/prerm"
          
          # Build package
          dpkg-deb --build "${PACKAGE_DIR}"
          mv "${PACKAGE_NAME}.deb" "speech2code-${VERSION}-linux-x86_64.deb"

      - name: Build .rpm package
        continue-on-error: true
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Setup RPM build environment
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Create source tarball
          tar czf ~/rpmbuild/SOURCES/speech2code-${VERSION}.tar.gz \
            --transform "s,^,speech2code-${VERSION}/," \
            desktop/target/release/speech2code-desktop \
            desktop/resources/speech2code.desktop \
            desktop/resources/speech2code.service
          
          # Copy and process spec file
          cp desktop/packaging/rpm/speech2code.spec ~/rpmbuild/SPECS/
          sed -i "s/VERSION/${VERSION}/" ~/rpmbuild/SPECS/speech2code.spec
          
          # Build RPM
          rpmbuild -bb ~/rpmbuild/SPECS/speech2code.spec
          
          # Copy RPM to workspace
          cp ~/rpmbuild/RPMS/x86_64/speech2code-${VERSION}-1.x86_64.rpm \
            speech2code-${VERSION}-linux-x86_64.rpm

      - name: Download AppImage tools
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Build AppImage
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy binary
          cp desktop/target/release/speech2code-desktop AppDir/usr/bin/
          
          # Copy desktop file
          cp desktop/resources/speech2code.desktop AppDir/usr/share/applications/
          
          # Copy or create icon
          if [ -f desktop/resources/icons/speech2code.png ]; then
            cp desktop/resources/icons/speech2code.png AppDir/usr/share/icons/hicolor/256x256/apps/
          else
            # Create a simple placeholder icon using convert
            convert -size 256x256 xc:blue -fill white -gravity center \
              -draw "circle 128,128 128,228" \
              AppDir/usr/share/icons/hicolor/256x256/apps/speech2code.png || \
            # Fallback: Create a minimal PNG if convert fails
            (sudo apt-get install -y imagemagick fonts-dejavu-core && \
             convert -size 256x256 xc:blue -fill white -gravity center -pointsize 48 \
               -font DejaVu-Sans -annotate 0 "S2C" AppDir/usr/share/icons/hicolor/256x256/apps/speech2code.png)
          fi
          
          # Create AppImage symlinks
          ln -sf usr/share/applications/speech2code.desktop AppDir/
          ln -sf usr/share/icons/hicolor/256x256/apps/speech2code.png AppDir/
          
          # Build AppImage
          ARCH=x86_64 VERSION=${VERSION} ./appimagetool-x86_64.AppImage AppDir \
            Speech2Code-${VERSION}-x86_64.AppImage

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            speech2code-*.deb
            speech2code-*.rpm
            Speech2Code-*.AppImage
          retention-days: 5

  android:
    name: Build Android APK
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Setup Android keystore
        working-directory: android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Get Flutter dependencies
        working-directory: android
        run: flutter pub get

      - name: Run Flutter tests
        working-directory: android
        run: flutter test || true

      - name: Build release APK
        working-directory: android
        run: flutter build apk --release

      - name: Rename APK
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cp android/build/app/outputs/flutter-apk/app-release.apk \
            speech2code-${VERSION}.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: speech2code-*.apk
          retention-days: 5

  source:
    name: Create Source Archive
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}
          fetch-depth: 0

      - name: Create source tarball
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          git archive --format=tar.gz --prefix=speech2code-${VERSION}/ \
            "v${VERSION}" > speech2code-${VERSION}-source.tar.gz

      - name: Upload source artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-archive
          path: speech2code-*-source.tar.gz
          retention-days: 5

  release:
    name: Create GitHub Release
    needs: [prepare, linux, android, source]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts/

      - name: Prepare release files
        run: |
          mkdir release-files
          find artifacts -type f -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cat > release-notes.md << 'EOF'
          ## Speech2Code v${{ needs.prepare.outputs.version }}
          
          ### Downloads
          
          **Linux:**
          - `.deb` - For Ubuntu/Debian-based systems
          - `.rpm` - For Fedora/RHEL-based systems
          - `.AppImage` - Universal Linux binary
          
          **Android:**
          - `.apk` - Android application package
          
          **Source:**
          - `-source.tar.gz` - Complete source code
          
          ### Installation
          
          #### Linux
          
          **Debian/Ubuntu:**
          ```bash
          sudo dpkg -i speech2code-${{ needs.prepare.outputs.version }}-linux-x86_64.deb
          ```
          
          **Fedora/RHEL:**
          ```bash
          sudo rpm -i speech2code-${{ needs.prepare.outputs.version }}-linux-x86_64.rpm
          ```
          
          **AppImage:**
          ```bash
          chmod +x Speech2Code-${{ needs.prepare.outputs.version }}-x86_64.AppImage
          ./Speech2Code-${{ needs.prepare.outputs.version }}-x86_64.AppImage
          ```
          
          #### Android
          
          1. Download the APK file
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install the APK
          4. Grant required permissions (Bluetooth, Microphone)
          
          ### What's Changed
          
          See the [commit history](https://github.com/${{ github.repository }}/commits/v${{ needs.prepare.outputs.version }}) for details.
          
          ### Requirements
          
          **Linux:**
          - Ubuntu 22.04+ or equivalent
          - GTK4, libadwaita
          - BlueZ (Bluetooth stack)
          - X11 or Wayland
          
          **Android:**
          - Android 6.0 (API 23) or higher
          - Bluetooth support
          - Microphone access
          
          ---
          
          **Full Documentation:** See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## Release Created Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release-files/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
